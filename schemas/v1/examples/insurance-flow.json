{
  "$schema": "https://schemas.xflows.com/v1/flows",
  "$id": "https://schemas.xflows.com/v1/examples/insurance-flow",
  "title": "Insurance Sales Flow Example",
  "description": "Complete example of insurance sales flow with plugin integration",
  "version": "1.0.0",
  "author": "Super Insurance Corp",
  "lastUpdated": "2024-12-19T17:00:00Z",
  
  "flowConfig": {
    "id": "insuranceSalesFlow",
    "initial": "quote.start",
    "context": {
      "dossierId": null,
      "riskScore": 0,
      "session": {
        "channel": "web",
        "userId": null,
        "location": "Mexico"
      },
      "applicant": {
        "name": "",
        "email": "",
        "age": null,
        "country": "MEX",
        "rfc": ""
      },
      "quote": {
        "type": "",
        "coverageAmount": 0,
        "premium": 0
      }
    },
    "states": {
      "quote.start": {
        "type": "atomic",
        "meta": {
          "view": {
            "moduleId": "mfe-quote-start",
            "description": "Initial quote request"
          },
          "icon": "üè∑Ô∏è"
        },
        "pluginUI": {
          "pluginId": "google-sheets",
          "config": {
            "spreadsheetId": "insurance-quotes-tracker",
            "range": "A1:J1000",
            "editable": true,
            "filters": true,
            "columnTypes": {
              "A": "text",
              "B": "email", 
              "C": "currency",
              "D": "date"
            }
          }
        },
        "on": {
          "QUOTE_SUBMITTED": {
            "target": "risk.validation",
            "actions": ["trackAnalytics"],
            "guard": "hasValidQuoteData"
          }
        }
      },
      
      "risk.validation": {
        "type": "atomic",
        "meta": {
          "view": {
            "moduleId": "mfe-risk-validation",
            "description": "Risk assessment and validation"
          },
          "icon": "üìä"
        },
        "pluginInvoke": [
          {
            "id": "documentAnalyzer",
            "pluginId": "aws-textract",
            "pluginType": "tool",
            "config": {
              "region": "us-east-1",
              "sourceDocument": "{{context.idDocumentUrl}}",
              "documentType": "identity-document",
              "analyzeIds": true,
              "extractTables": false,
              "extractForms": false
            },
            "timeout": 30000,
            "retryPolicy": {
              "attempts": 3,
              "retryDelay": 2000,
              "backoff": "exponential"
            }
          }
        ],
        "pluginUI": {
          "pluginId": "aws-cloudwatch",
          "config": {
            "region": "us-east-1",
            "namespace": "SuperInsurance/RiskValidation",
            "timeRange": {
              "start": "-1h",
              "end": "now",
              "period": 300
            },
            "metrics": [
              {
                "name": "DocumentProcessingTime",
                "statistic": "Average"
              },
              {
                "name": "ValidationFailures",
                "statistic": "Sum"
              },
              {
                "name": "RiskScoreDistribution",
                "statistic": "Average"
              }
            ]
          }
        },
        "pluginActions": [
          {
            "actionId": "riskAnalysisTracking",
            "pluginId": "google-analytics",
            "config": {
              "propertyId": "GA4-SUPER-INSURANCE",
              "eventName": "risk_analysis_started",
              "eventParameters": {
                "policy_type": "{{context.quote.type}}",
                "coverage_amount": "{{context.quote.coverageAmount}}",
                "applicant_age": "{{context.applicant.age}}",
                "country": "{{context.applicant.country}}"
              },
              "userId": "{{context.session.userId}}"
            },
            "condition": {
              "!=": ["{{context.applicant.age}}", null]
            }
          }
        ],
        "on": {
          "DOCUMENT_VALIDATED": {
            "target": "risk.ai-assessment",
            "actions": ["logDocumentValidation"]
          },
          "VALIDATION_FAILED": {
            "target": "quote.error",
            "actions": ["sendNotification", "logError"]
          }
        }
      },
      
      "risk.ai-assessment": {
        "type": "atomic",
        "meta": {
          "view": {
            "moduleId": "mfe-ai-assessment",
            "description": "AI-powered risk scoring"
          },
          "icon": "ü§ñ"
        },
        "pluginInvoke": [
          {
            "id": "mlRiskModel",
            "pluginId": "custom-ml-api",
            "pluginType": "tool", 
            "config": {
              "endpoint": "https://api.mlprovider.com/models/risk-score",
              "model": "super-insurance-risk-v2",
              "inputFeatures": [
                "age", "vehicle_year", "driving_record", 
                "location", "history_length"
              ],
              "confidenceThreshold": 0.8
            },
            "timeout": 45000
          }
        ],
        "pluginActions": [
          {
            "actionId": "riskPredictionTracking", 
            "pluginId": "google-analytics",
            "config": {
              "propertyId": "GA4-SUPER-INSURANCE",
              "eventName": "ml_risk_prediction",
              "eventParameters": {
                "model_version": "super-insurance-risk-v2",
                "prediction_confidence": "{{context.predictionConfidence}}",
                "risk_category": "{{context.riskCategory}}"
              }
            }
          }
        ],
        "on": {
          "RISK_ANALYZED": {
            "target": "notification.slack-review",
            "actions": ["calculatePremium", "generateReport"]
          },
          "ML_FAILED": {
            "target": "risk.fallback-assessment"
          }
        }
      },
      
      "notification.slack-review": {
        "type": "atomic",
        "meta": {
          "view": {
            "moduleId": "mfe-slack-notification",
            "description": "Manual review notification"
          },
          "icon": "üí¨"
        },
        "pluginActions": [
          {
            "actionId": "notifyUnderwriters",
            "pluginId": "slack",
            "config": {
              "webhookUrl": "https://hooks.slack.com/services/SLACK-WEBHOOK",
              "channel": "#underwriting-review",
              "username": "Insurance Review Bot",
              "iconEmoji": ":shield:",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "üéØ *New Insurance Application*\n*Customer:* {{context.applicant.name}}\n*Policy Type:* {{context.quote.type}}\n*Coverage:* ${{context.quote.coverageAmount}}\n*Risk Score:* {{context.riskScore}}%"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ML Analysis:* {{context.mlAnalysis}}\n*Recommended Action:* {{context.recommendedAction}}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {"type": "plain_text", "text": "‚úÖ Approve"},
                      "style": "primary",
                      "action_id": "approve_policy"
                    },
                    {
                      "type": "button",
                      "text": {"type": "plain_text", "text": "‚ùå Reject"},
                      "style": "danger", 
                      "action_id": "reject_policy"
                    },
                    {
                      "type": "button",
                      "text": {"type": "plain_text", "text": "ü§î Manual Review"},
                      "action_id": "manual_review"
                    }
                  ]
                }
              ]
            }
          }
        ],
        "on": {
          "APPROVED": {
            "target": "policy.creation",
            "actions": ["logApproval"]
          },
          "REJECTED": {
            "target": "quote.rejection",
            "actions": ["sendRejectionEmail"]
          },
          "NEEDS_MORE_INFO": {
            "target": "quote.additional-data"
          }
        }
      },
      
      "policy.creation": {
        "type": "atomic",
        "meta": {
          "view": {
            "moduleId": "mfe-policy-creation",
            "description": "Policy creation and database storage"
          },
          "icon": "üìú"
        },
        "pluginInvoke": [
          {
            "id": "createPolicyRecord",
            "pluginId": "mysql",
            "pluginType": "tool",
            "config": {
              "host": "prod-mysql.superinsurance.com",
              "port": 3306,
              "database": "policy_management",
              "username": "policy_service",
              "operation": "INSERT",
              "query": "INSERT INTO policies (user_id, policy_number, premium, start_date, status, risk_score, ml_model, ml_confidence) VALUES (?, ?, ?, ?, ?, ?, ?, ?)",
              "parameters": {
                "user_id": "{{context.applicant.userId}}",
                "policy_number": "\\\\{{`POL-${Date.now()}-${Math.random().toString(36).substr(2, 6).toUpperCase()}`}}",
                "premium": "{{context.quote.premium}}",
                "start_date": "{{context.effectiveDate}}",
                "status": "ACTIVE",
                "risk_score": "{{context.riskScore}}",
                "ml_model": "super-insurance-risk-v2",
                "ml_confidence": "{{context.predictionConfidence}}"
              }
            },
            "timeout": 15000
          }
        ],
        "pluginActions": [
          {
            "actionId": "welcomeEmail",
            "pluginId": "sendgrid",
            "config": {
              "apiKey": "SG.SUPER-INSURANCE-KEY",
              "fromEmail": "noreply@superinsurance.com",
              "fromName": "Super Insurance Team",
              "templateId": "welcome-insurance-policy",
              "dynamicTemplateData": {
                "firstName": "{{context.applicant.name.split(' ')[0]}}",
                "lastName": "{{context.applicant.name.split(' ')[1] || ''}}",
                "policyNumber": "\\\\{{`POL-${Date.now()}-${Math.random().toString(36).substr(2, 6).toUpperCase()}`}}",
                "premiumAmount": "${{context.quote.premium}}",
                "premiumFrequency": "Monthly",
                "coverageAmount": "${{context.quote.coverageAmount.toLocaleString()}}",
                "effectiveDate": "{{context.effectiveDate}}",
                "companyName": "Super Insurance Corp",
                "contactEmail": "support@superinsurance.com",
                "contactPhone": "+52 55 1234-5678"
              }
            }
          },
          {
            "actionId": "s3DocumentUpload",
            "pluginId": "aws-s3-upload",
            "config": {
              "bucket": "super-insurance-policies",
              "region": "us-east-1",
              "keyTemplate": "policies/{{year}}/{{month}}/POL-{{dossierId}}/policy-document.pdf",
              "maxFileSize": 5242880,
              "allowedExtensions": [".pdf"]
            },
            "condition": {
              "!=": ["{{context.policyDocument}}", null]
            }
          }
        ],
        "on": {
          "POLICY_CREATED": {
            "target": "completed",
            "actions": ["trackPolicyCreation", "sendWelcomeNotification"]
          },
          "DB_ERROR": {
            "target": "policy.error",
            "actions": ["logDatabaseError", "notifyAdmin"]
          }
        }
      },
      
      "completed": {
        "type": "final",
        "meta": {
          "view": {
            "moduleId": "mfe-success",
            "description": "Application completed successfully"
          },
          "icon": "‚úÖ"
        },
        "pluginActions": [
          {
            "actionId": "finalAnalytics",
            "pluginId": "google-analytics",
            "config": {
              "propertyId": "GA4-SUPER-INSURANCE",
              "eventName": "policy_application_completed",
              "eventParameters": {
                "policy_number": "{{context.policyNumber}}",
                "processing_time": "{{context.processingTime}}",
                "risk_category": "{{context.riskCategory}}",
                "ml_model_used": "{{context.mlModel}}"
              }
            }
          }
        ]
      },
      
      "quote.error": {
        "type": "final",
        "meta": {
          "view": {
            "moduleId": "mfe-error",
            "description": "Quote error state"
          },
          "icon": "‚ùå"
        }
      },
      
      "quote.rejection": {
        "type": "final",
        "meta": {
          "view": {
            "moduleId": "mfe-rejection",
            "description": "Quote rejection state"
          },
          "icon": "üö´"
        },
        "pluginActions": [
          {
            "actionId": "rejectionEmail",
            "pluginId": "aws-ses",
            "config": {
              "region": "us-east-1",
              "fromEmail": "no-reply@superinsurance.com",
              "toEmails": ["{{context.applicant.email}}"],
              "subject": "Insurance Application Update - {{context.policyNumber}}",
              "template": "Dear {{context.applicant.name}},\\n\\nWe regret to inform you that your insurance application has been rejected due to: {{context.rejectionReason}}\\n\\nOur underwriters will contact you to discuss alternative options.\\n\\nThank you for considering Super Insurance Corp."
            }
          }
        ]
      },
      
      "policy.error": {
        "type": "final",
        "meta": {
          "view": {
            "moduleId": "mfe-error",
            "description": "Policy creation error"
          },
          "icon": "üí•"
        }
      }
    },
    "plugins": {
      "tools": {
        "documentAnalyzer": {
          "id": "aws-textract",
          "config": {
            "region": "us-east-1",
            "maxFileSize": 10485760,
            "allowedTypes": ["pdf", "png", "jpg"],
            "confidenceThreshold": 0.85
          },
          "enabled": true
        },
        "databaseOps": {
          "id": "mysql",
          "config": {
            "connectionPool": {
              "max": 20,
              "min": 5,
              "idle": 10000
            },
            "timeout": 30000,
            "retryPolicy": {
              "attempts": 3,
              "retryDelay": 1000
            }
          },
          "enabled": true
        },
        "mlRiskApi": {
          "id": "custom-ml-api",
          "config": {
            "baseUrl": "https://api.mlprovider.com",
            "authToken": "ml-auth-token",
            "timeout": 45000,
            "retries": 2
          },
          "enabled": true
        },
        "documentStorage": {
          "id": "aws-s3-upload",
          "config": {
            "region": "us-east-1",
            "bucket": "super-insurance-documents",
            "keyPrefix": "policies/",
            "cloudfrontDistribution": "distribution123"
          },
          "enabled": true
        }
      },
      "actions": {
        "analytics": {
          "id": "google-analytics",
          "config": {
            "propertyId": "GA4-SUPER-INSURANCE",
            "measurementId": "G-SUPER-INSURANCE",
            "userId": "{{context.session.userId}}",
            "sessionId": "{{context.sessionId}}"
          },
          "enabled": true
        },
        "emailNotifications": {
          "id": "sendgrid",
          "config": {
            "apiKey": "SG.SUPER-INSURANCE-KEY",
            "fromEmail": "noreply@superinsurance.com",
            "fromName": "Super Insurance Corp",
            "templateDomain": "superinsurance.com"
          },
          "enabled": true
        },
        "slackNotifications": {
          "id": "slack",
          "config": {
            "webhookUrl": "https://hooks.slack.com/services/SLACK-KEY",
            "defaultChannel": "#general",
            "username": "Super Insurance Bot",
            "iconEmoji": ":shield:"
          },
          "enabled": true
        },
        "awsEmail": {
          "id": "aws-ses",
          "config": {
            "region": "us-east-1",
            "verifiedDomain": "superinsurance.com",
            "fromEmail": "noreply@superinsurance.com"
          },
          "enabled": false
        }
      },
      "guards": {
        "businessHours": {
          "id": "time-based",
          "config": {
            "condition": "businessHours",
            "timezone": "America/Mexico_City",
            "graceMinutes": 30
          },
          "enabled": true
        },
        "rateLimit": {
          "id": "rate-limit",
          "config": {
            "maxRequests": 100,
            "windowMs": 3600000,
            "skipSuccessfulRequests": false
          },
          "enabled": true
        },
        "dataValidation": {
          "id": "custom-validation",
          "config": {
            "schema": "insurance-applicant-schema",
            "strictMode": true,
            "stopOnError": true
          },
          "enabled": true
        }
      },
      "ui": {
        "metricsDashboard": {
          "id": "aws-cloudwatch",
          "config": {
            "refreshInterval": 30000,
            "maxDataPoints": 100,
            "chartTypes": ["line", "gauge", "counter"]
          },
          "enabled": true
        },
        "spreadsheetUI": {
          "id": "google-sheets",
          "config": {
            "authScope": "sheets",
            "editingPermissions": "users",
            "cellFormatting": true
          },
          "enabled": true
        },
        "mapsIntegration": {
          "id": "mapbox",
          "config": {
            "accessToken": "MAPBOX-SUPER-INSURANCE",
            "mapStyle": "streets-v11",
            "interactiveMarkers": true
          },
          "enabled": false
        }
      }
    }
  }
}
